<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.16.1/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.3.0/vue.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.1/css/bulma.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <title>Nuvi-Labs Kakao Page</title>
</head>
<style>
  html, body {
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
  }


  #app {
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #E6E6E6;
  }

  #app .column {
    margin-top: 10%;
  }

  #app .column > p {
    text-align: center;
  }

  #sign-up-button {
    float: right;
  }

  .selectbox { 
    position: relative; 
    width: 100%; 
    height: 35px;
    border: 1px solid #E6E6E6;  
  }
</style>

<body>
  <!--main container-->
  <div class="columns is-mobile" id="app">
    <!--centered column-->
    <div class="column is-half is-offset-one-quarter">

      <p class="title is-2 is-spaced">Nuvi-Lab Register</p>

      <!--login form-->
      <div class="box">
          <div class="field">
            <p class="control has-icons-left">
              <select class="selectbox" id="school" name="school" style="color:#6E6E6E; font-size: 15">
                <option value="">학교 선택</option>
                <%for(var i=0;i<school.length;i++){%>
                  <option value="<%=code[i]%>"><%=school[i]%></option>
                <%}%>
              </select>
            </p>
          </div>
          <div class="field">
              <select class="selectbox" id="user_type" name="user_type" style="color:#6E6E6E; font-size: 15">
                <option value="">학생/학부모 선택</option>
                <option value="학생">학생</option>
                <option value="학부모">학부모</option>
              </select>
          </div>
          <div class="field">
              <input id="code" class="input" type="text" placeholder="코드">
          </div>
          <div class="field">
              <input id="name" class="input" type="text" placeholder="이름">
          </div>
          
          <div class="field">
            <p class="control">
              <button class="button is-success" id="log-in-button" >
                완료
              </button>

            </p>
          *입력 정보가 정확하지 않을 경우 가입이 불가능하니 정확하게 입력해주시길 바랍니다.
          <p id="info_check" style="color: red"></p>
          </div>

        
      </div>
      <!--end of form-->

    </div>
    <!--end of column-->
  </div>
  <!--end of container-->
</body>
<script>
  $('#code').change(function(){
    $.ajax({
              url: '/kakao/codeCheck',
              dataType: 'json',
              type: 'POST',
              data: {'code':$('#code').val(),'school':$('#school').val()},
              success: function(result) {
                  if(result.length==0){
                      $('#info_check').html("존재하지 않는 코드입니다.");
                  }else{
                    if($('#user_type').val()=="학생" && result.chat_id!=null)
                      $('#info_check').html("이미 등록된 학생 아이디입니다.");
                    else{
                      $('#info_check').html("");
                    }
                  }
              }
          });
  });

  $('#name').change(function(){
    $.ajax({
              url: '/kakao/nameCheck',
              dataType: 'json',
              type: 'POST',
              data: {'code':$('#code').val(),'name':$('#name').val(),'school':$('#school').val()},
              success: function(result) {
                  if(result.length==0){
                      $('#info_check').html("입력한 코드와 학생의 이름이 일치하지 않습니다.");
                  }else{
                      $('#info_check').html("");
                  }
              }
          });
  });

  $('#log-in-button').click(function(){
    var chat_id = "<%=kakao%>";
    if(chat_id==""){
      alert("올바르지 않은 접근입니다.\n누비랩 챗봇을 통해 접속해주십시오.");
      return;
    }

    if($('#user_type').val()=="" || $('#school').val()=="" || $('#code').val()=="" || $('#name').val()==""){
      $('#info_check').html("정보를 모두 입력해주시길 바랍니다.");
    }else{
      $.ajax({
              url: '/kakao/registerComplete',
              dataType: 'json',
              type: 'POST',
              data: { 'type':$('#user_type').val(),
                      'school':$('#school').val(),
                      'code':$('#code').val(),
                      'name':$('#name').val(),
                      'chat':"<%=kakao%>"},
              success: function(result) {
                  if(result==null){
                    alert("입력하신 정보가 정확하지 않습니다. 확인해주세요.");
                  }else{
                   window.location.href=result.redirectURL; 
                  }
              }
      });
    }
  });

</script>
</html>